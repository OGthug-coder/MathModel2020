<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        canvas {
            border: 1px solid black;
        }

        .main {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .controls {
            display: grid;
            width: min-content;
            height: min-content;
            grid-auto-flow: row;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            grid-gap: 5px;
        }
    </style>
</head>
<body>
<div class="main">
    <div>Количество шагов</div>
    <input id="steps" type="range" min=10 max=1000 step=1>
    <div class="controls">
        <div>
            <div>Угол 1</div>
            <input id="angle_1" value=30 type="number" step="0.1">
        </div>
        <div>
            <div>Масса 1</div>
            <input id="m_1" value=1 type="number" step="0.1">
        </div>
        <div>
            <div>Длина 1</div>
            <input id="l_1" value=1 type="number" step="0.1">
        </div>
        <div>
            <div>Скорость 1</div>
            <input id="speed_1" value=0 type="number" step="0.1">
        </div>
        <div>
            <div>Угол 2</div>
            <input id="angle_2" value=0 type="number" step="0.1">
        </div>
        <div>
            <div>Масса 2</div>
            <input id="m_2" value=1 type="number" step="0.1">
        </div>
        <div>
            <div>Длина 2</div>
            <input id="l_2" value=1 type="number" step="0.1">
        </div>
        <div>
            <div>Скорость 2</div>
            <input id="speed_2" value=0 type="number" step="0.1">
        </div>
    </div>
    <button onclick="startModel()">Start</button>
    <button onclick="stopModel()">Stop</button>
    <canvas id="canvas" width="700" height="700"></canvas>
</div>
</body>
<script>
    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    ctx.lineWidth = 10;

    let x0 = 700 / 2;
    let y0 = 700 / 2;

    let l1 = 100;
    let l2 = 100;

    let N = 0;
    let PHI, THETA;

    let timer;

    prepareData = (text) => {
        let phiValues = [];
        let thetaValues = [];
        let tmp = text.split(/\r?\n/);

        for (let i = 0; i < tmp.length; i++) {
            let pair = tmp[i].split(";");
            phiValues.push(parseFloat(pair[0]));
            thetaValues.push(parseFloat(pair[1]));
        }
        return [phiValues, thetaValues];
    };

    stopModel = () => {
        clearInterval(timer);
        N = 0;
    };

    startModel = () => {
        if (N !== 0) stopModel()
        fetchData();
    };

    fetchData = () => {
        let body = {
            steps: document.getElementById("steps").value,
            l_1: document.getElementById("l_1").value,
            l_2: document.getElementById("l_2").value,
            m_1: document.getElementById("m_1").value,
            m_2: document.getElementById("m_2").value,
            angle_1: document.getElementById("angle_1").value,
            angle_2: document.getElementById("angle_2").value,
            speed_1: document.getElementById("speed_1").value,
            speed_2: document.getElementById("speed_2").value
        };

        for (let [key, value] of Object.entries(body)) {
            // convert deg to rad
            if (key.includes("angle")) {
                value = (parseInt(value) * Math.PI / 180).toFixed(2);
            }
            body[key] = parseFloat(value);
        }

        console.log(body);

        fetch("http://localhost:8085", {method: "POST", body: JSON.stringify(body)})
            .then(response => response.text())
            .then(text => {
                let data = prepareData(text);
                let phi = data[0];
                let theta = data[1];
                PHI = phi;
                THETA = theta;
                timer = setInterval(() => {
                    draw(PHI[N], THETA[N], body.l_1, body.l_2);
                    N++;
                    if (PHI[N] === undefined || THETA[N] === undefined) {
                        clearInterval(timer);
                    }
                }, 100);
            });
    };


    draw = (phi, theta, l1, l2) => {
        l2 = l2 / l1 * 100;

        l1 = 100;
        if (l2 > 200) {
            l2 = l2 / l1 * 50;
            l1 = 50;
        } else if (l2 > 300) {
            l2 = l2 / l1 * 25;
            l1 = 25;
        }
        ctx.clearRect(0, 0, 700, 700);

        ctx.beginPath();
        ctx.arc(x0, y0, 10, 0, 2 * Math.PI);
        ctx.fill();

        ctx.strokeStyle = "red";
        ctx.beginPath();
        ctx.moveTo(x0, y0);
        ctx.lineTo(x0 + l1 * Math.sin(phi), y0 + l1 * Math.cos(phi));
        ctx.stroke();

        ctx.strokeStyle = "blue";
        ctx.beginPath();
        ctx.moveTo(x0 + l1 * Math.sin(phi), y0 + l1 * Math.cos(phi));
        ctx.lineTo(x0 + l1 * Math.sin(phi) + l2 * Math.sin(theta), y0 + l1 * Math.cos(phi) + l2 * Math.cos(theta));
        ctx.stroke();
    };
</script>
</html>